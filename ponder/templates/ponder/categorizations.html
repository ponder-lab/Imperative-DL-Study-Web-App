{% extends "ponder/base.html" %}
{% load crispy_forms_tags %}
{% load static %}
{% block body_block %}
{% load widget_tweaks %}

<title>Categorization Form</title>
<script type="module">
  class DetailsMenuElement extends HTMLElement {
      constructor() {
          super();
      }
      get preload() {
          return this.hasAttribute('preload');
      }
      set preload(value) {
          if (value) {
              this.setAttribute('preload', '');
          }
          else {
              this.removeAttribute('preload');
          }
      }
      get src() {
          return this.getAttribute('src') || '';
      }
      set src(value) {
          this.setAttribute('src', value);
      }
      connectedCallback() {
          if (!this.hasAttribute('role'))
              this.setAttribute('role', 'menu');
          const details = this.parentElement;
          if (!details)
              return;
          const summary = details.querySelector('summary');
          if (summary) {
              summary.setAttribute('aria-haspopup', 'menu');
              if (!summary.hasAttribute('role'))
                  summary.setAttribute('role', 'button');
          }
          const subscriptions = [
              fromEvent(details, 'compositionstart', e => trackComposition(this, e)),
              fromEvent(details, 'compositionend', e => trackComposition(this, e)),
              fromEvent(details, 'click', e => shouldCommit(details, this, e)),
              fromEvent(details, 'change', e => shouldCommit(details, this, e)),
              fromEvent(details, 'keydown', e => keydown(details, this, e)),
              fromEvent(details, 'toggle', () => loadFragment(details, this), { once: true }),
              fromEvent(details, 'toggle', () => closeCurrentMenu(details)),
              this.preload
                  ? fromEvent(details, 'mouseover', () => loadFragment(details, this), { once: true })
                  : NullSubscription,
              ...focusOnOpen(details)
          ];
          states.set(this, { subscriptions, loaded: false, isComposing: false });
      }
      disconnectedCallback() {
          const state = states.get(this);
          if (!state)
              return;
          states.delete(this);
          for (const sub of state.subscriptions) {
              sub.unsubscribe();
          }
      }
  }
  const states = new WeakMap();
  const NullSubscription = {
      unsubscribe() {
      }
  };
  function fromEvent(target, eventName, onNext, options = false) {
      target.addEventListener(eventName, onNext, options);
      return {
          unsubscribe: () => {
              target.removeEventListener(eventName, onNext, options);
          }
      };
  }
  function loadFragment(details, menu) {
      const src = menu.getAttribute('src');
      if (!src)
          return;
      const state = states.get(menu);
      if (!state)
          return;
      if (state.loaded)
          return;
      state.loaded = true;
      const loader = menu.querySelector('include-fragment');
      if (loader && !loader.hasAttribute('src')) {
          loader.addEventListener('loadend', () => autofocus(details));
          loader.setAttribute('src', src);
      }
  }
  function focusOnOpen(details) {
      let isMouse = false;
      const onmousedown = () => (isMouse = true);
      const onkeydown = () => (isMouse = false);
      const ontoggle = () => {
          if (!details.hasAttribute('open'))
              return;
          if (autofocus(details))
              return;
          if (!isMouse)
              focusFirstItem(details);
      };
      return [
          fromEvent(details, 'mousedown', onmousedown),
          fromEvent(details, 'keydown', onkeydown),
          fromEvent(details, 'toggle', ontoggle)
      ];
  }
  function closeCurrentMenu(details) {
      if (!details.hasAttribute('open'))
          return;
      for (const menu of document.querySelectorAll('details[open] > details-menu')) {
          const opened = menu.closest('details');
          if (opened && opened !== details && !opened.contains(details)) {
              opened.removeAttribute('open');
          }
      }
  }
  function autofocus(details) {
      if (!details.hasAttribute('open'))
          return false;
      const input = details.querySelector('[autofocus]');
      if (input) {
          input.focus();
          return true;
      }
      else {
          return false;
      }
  }
  function focusFirstItem(details) {
      const selected = document.activeElement;
      if (selected && isMenuItem(selected) && details.contains(selected))
          return;
      const target = sibling(details, true);
      if (target)
          target.focus();
  }
  function sibling(details, next) {
      const options = Array.from(details.querySelectorAll('[role^="menuitem"]:not([hidden]):not([disabled]):not([aria-disabled="true"])'));
      const selected = document.activeElement;
      const index = selected instanceof HTMLElement ? options.indexOf(selected) : -1;
      const found = next ? options[index + 1] : options[index - 1];
      const def = next ? options[0] : options[options.length - 1];
      return found || def;
  }
  const ctrlBindings = navigator.userAgent.match(/Macintosh/);
  function shouldCommit(details, menu, event) {
      const target = event.target;
      if (!(target instanceof Element))
          return;
      if (target.closest('details') !== details)
          return;
      if (event.type === 'click') {
          const menuitem = target.closest('[role="menuitem"], [role="menuitemradio"]');
          const onlyCommitOnChangeEvent = menuitem && menuitem.tagName === 'LABEL' && menuitem.querySelector('input');
          if (menuitem && !onlyCommitOnChangeEvent) {
              commit(menuitem, details);
          }
      }
      else if (event.type === 'change') {
          const menuitem = target.closest('[role="menuitemradio"], [role="menuitemcheckbox"]');
          if (menuitem)
              commit(menuitem, details);
      }
  }
  function updateChecked(selected, details) {
      for (const el of details.querySelectorAll('[role="menuitemradio"], [role="menuitemcheckbox"]')) {
          const input = el.querySelector('input[type="radio"], input[type="checkbox"]');
          let checkState = (el === selected).toString();
          if (input instanceof HTMLInputElement) {
              checkState = input.indeterminate ? 'mixed' : input.checked.toString();
          }
          el.setAttribute('aria-checked', checkState);
      }
  }
  function commit(selected, details) {
      if (selected.hasAttribute('disabled') || selected.getAttribute('aria-disabled') === 'true')
          return;
      const menu = selected.closest('details-menu');
      if (!menu)
          return;
      const dispatched = menu.dispatchEvent(new CustomEvent('details-menu-select', {
          cancelable: true,
          detail: { relatedTarget: selected }
      }));
      if (!dispatched)
          return;
      updateLabel(selected, details);
      updateChecked(selected, details);
      if (selected.getAttribute('role') !== 'menuitemcheckbox')
          close(details);
      menu.dispatchEvent(new CustomEvent('details-menu-selected', {
          detail: { relatedTarget: selected }
      }));
  }
  function keydown(details, menu, event) {
      if (!(event instanceof KeyboardEvent))
          return;
      if (details.querySelector('details[open]'))
          return;
      const state = states.get(menu);
      if (!state || state.isComposing)
          return;
      const isSummaryFocused = event.target instanceof Element && event.target.tagName === 'SUMMARY';
      switch (event.key) {
          case 'Escape':
              if (details.hasAttribute('open')) {
                  close(details);
                  event.preventDefault();
                  event.stopPropagation();
              }
              break;
          case 'ArrowDown':
              {
                  if (isSummaryFocused && !details.hasAttribute('open')) {
                      details.setAttribute('open', '');
                  }
                  const target = sibling(details, true);
                  if (target)
                      target.focus();
                  event.preventDefault();
              }
              break;
          case 'ArrowUp':
              {
                  if (isSummaryFocused && !details.hasAttribute('open')) {
                      details.setAttribute('open', '');
                  }
                  const target = sibling(details, false);
                  if (target)
                      target.focus();
                  event.preventDefault();
              }
              break;
          case 'n':
              {
                  if (ctrlBindings && event.ctrlKey) {
                      const target = sibling(details, true);
                      if (target)
                          target.focus();
                      event.preventDefault();
                  }
              }
              break;
          case 'p':
              {
                  if (ctrlBindings && event.ctrlKey) {
                      const target = sibling(details, false);
                      if (target)
                          target.focus();
                      event.preventDefault();
                  }
              }
              break;
          case ' ':
          case 'Enter':
              {
                  const selected = document.activeElement;
                  if (selected instanceof HTMLElement && isMenuItem(selected) && selected.closest('details') === details) {
                      event.preventDefault();
                      event.stopPropagation();
                      selected.click();
                  }
              }
              break;
      }
  }
  function isMenuItem(el) {
      const role = el.getAttribute('role');
      return role === 'menuitem' || role === 'menuitemcheckbox' || role === 'menuitemradio';
  }
  function close(details) {
      const wasOpen = details.hasAttribute('open');
      if (!wasOpen)
          return;
      details.removeAttribute('open');
      const summary = details.querySelector('summary');
      if (summary)
          summary.focus();
  }
  function updateLabel(item, details) {
      const button = details.querySelector('[data-menu-button]');
      if (!button)
          return;
      const text = labelText(item);
      if (text) {
          button.textContent = text;
      }
      else {
          const html = labelHTML(item);
          if (html)
              button.innerHTML = html;
      }
  }
  function labelText(el) {
      if (!el)
          return null;
      const textEl = el.hasAttribute('data-menu-button-text') ? el : el.querySelector('[data-menu-button-text]');
      if (!textEl)
          return null;
      return textEl.getAttribute('data-menu-button-text') || textEl.textContent;
  }
  function labelHTML(el) {
      if (!el)
          return null;
      const contentsEl = el.hasAttribute('data-menu-button-contents') ? el : el.querySelector('[data-menu-button-contents]');
      return contentsEl ? contentsEl.innerHTML : null;
  }
  function trackComposition(menu, event) {
      const state = states.get(menu);
      if (!state)
          return;
      state.isComposing = event.type === 'compositionstart';
  }
  export default DetailsMenuElement;
  if (!window.customElements.get('details-menu')) {
      window.DetailsMenuElement = DetailsMenuElement;
      window.customElements.define('details-menu', DetailsMenuElement);
  }

</script>
<div class="card-body">
  <div class="container">
    <div class="jumbotron">
      <h1>Categorization Form</h1>
        <h3>Fill categorization for {{ sha }}.</h3>
        <div style = "height: 20px"></div>
        <a style="background-color: lightblue; box-shadow: 0 1px 0 blue; color: white; padding: .5em .5em;position: relative;text-decoration: none;color:black;" href={{commit_url}}>Specific commit</a>
        <a style="background-color: lightblue; box-shadow: 0 1px 0 blue; color: white; padding: .5em .5em;position: relative;text-decoration: none;color:black;" href={{general_url}}>General Sha Search</a>
        <div style = "height: 20px"></div>
        <h5>The buttons above take you to specific commit link for the sha, and the general search of the sha in the project.</h5>
        <form enctype="multipart/form-data" method="POST">
          {% csrf_token %}
          {% for hidden_field in cat_form.hidden_fields %}
            {{ hidden_field }}
          {% endfor %}
          {% for field in cat_form.visible_fields %}
            <div class="form-group">
              {{ field.label_tag }}
              {% if field.name == "is_func_fix" or field.name == "should_discuss" %}
              {% render_field field %}
              {% else %}
                {% if field.name == "problem_category" or field.name == "problem_cause" or field.name == "problem_fix" or field.name == "problem_symptom" %}
                <details-menu
                  src="{% url 'ponder:filtering'%}"
                  class="select-menu-modal position-absolute right-0 hx_rsm-modal"
                  style="z-index: 99; overflow: visible;"
                  data-multiple>
                    <div class="select-menu-filters">
                <div class="select-menu-text-filter">
                  <input type="text" id="label-filter-field" class="form-control js-label-filter-field js-filterable-field"
                         placeholder="Filter categories" aria-label="Filter labels" autocomplete="off" autofocus>
                </div>
              </div>

                  <div class="hx_rsm-content" role="menu">
                      <include-fragment>
                        <svg style="box-sizing: content-box;" viewBox="0 0 16 16" fill="none" width="32" height="32" class="my-6 mx-auto d-block">
                          <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-opacity="0.25" stroke-width="2" vector-effect="non-scaling-stroke" />
                          <path d="M15 8a7.002 7.002 0 00-7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" vector-effect="non-scaling-stroke">
                            <animateTransform attributeName="transform" type="rotate" from="0 8 8" to="360 8 8" dur="1s" repeatCount="indefinite" />
                          </path>
                        </svg>
                      </include-fragment>
                  </div>
                </details-menu>
              {% endif %}
              {% render_field field class="form-control" %}
              {% endif %}
              {% if field.help_text %}
                <small class="form-text text-muted">{{ field.help_text }}</small>
              {% endif %}
            </div>
          {% endfor %}
          <input type="submit" name="" value="Add">
        </form>
    </div>
  </div> 
</div>
{% endblock %}
